# ğŸ—ºï¸ V-EdFinance Database Tools Integration Plan

> **Káº¿ hoáº¡ch tÃ­ch há»£p toÃ n diá»‡n 4 cÃ´ng cá»¥ database vÃ o há»‡ thá»‘ng EdTech**

---

## ğŸ“Š Tool Positioning Matrix

| Tool | Primary Use | Environment | Integration Level |
|------|-------------|-------------|-------------------|
| **Prisma ERD** | Documentation & Communication | All | CI/CD Automated |
| **Snaplet** | Testing & Development Data | Dev/Test/CI | Build Pipeline |
| **NocoDB** | Admin Operations & Content Management | Dev/Staging | Standalone UI |
| **Kysely** | Complex Analytics Queries | All | Deep NestJS Integration |

---

## ğŸ¯ Implementation Phases

### Phase 1: Foundation Setup (Week 1)
- [ ] Enhanced ERD configuration vá»›i domain-specific views
- [ ] Snaplet factory setup cho EdTech data models
- [ ] NocoDB production-safe configuration

### Phase 2: Module Integration (Week 2-3)
- [ ] Kysely Analytics Repository
- [ ] Gamification module Kysely queries
- [ ] Testing + documentation

### Phase 3: CI/CD Integration (Week 4)
- [ ] GitHub Actions workflow
- [ ] Pre-commit hooks + automated ERD
- [ ] Integration testing

### Phase 4: Environment Configuration (Week 5)
- [ ] Environment-specific configs
- [ ] Team training & documentation

---

## ğŸ“ Directory Structure

```
apps/api/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma          # âœ… Already configured with generators
â”‚   â””â”€â”€ seeds/
â”‚       â”œâ”€â”€ index.ts           # Main seed orchestrator
â”‚       â”œâ”€â”€ scenarios/
â”‚       â”‚   â”œâ”€â”€ dev.seed.ts    # Development (50 users, 10 courses)
â”‚       â”‚   â”œâ”€â”€ test.seed.ts   # CI/CD testing (20 users, 5 courses)
â”‚       â”‚   â”œâ”€â”€ demo.seed.ts   # Demo/staging (200 users, 25 courses)
â”‚       â”‚   â””â”€â”€ benchmark.seed.ts # Performance (10k users, 100 courses)
â”‚       â”œâ”€â”€ factories/
â”‚       â”‚   â”œâ”€â”€ user.factory.ts
â”‚       â”‚   â”œâ”€â”€ course.factory.ts
â”‚       â”‚   â”œâ”€â”€ behavior.factory.ts
â”‚       â”‚   â””â”€â”€ gamification.factory.ts
â”‚       â””â”€â”€ data/
â”‚           â”œâ”€â”€ courses.json   # Realistic course templates
â”‚           â”œâ”€â”€ achievements.json
â”‚           â””â”€â”€ locales.json   # i18n strings
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ database/              # âœ… Already created
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ types.ts           # âœ… Auto-generated by prisma-kysely
â”‚   â”‚   â”œâ”€â”€ enums.ts           # âœ… Auto-generated by prisma-kysely
â”‚   â”‚   â”œâ”€â”€ kysely.module.ts   # âœ… Created
â”‚   â”‚   â””â”€â”€ kysely.service.ts  # âœ… Created
â”‚   â””â”€â”€ analytics/
â”‚       â”œâ”€â”€ analytics.module.ts
â”‚       â”œâ”€â”€ analytics.repository.ts  # Kysely complex queries
â”‚       â””â”€â”€ queries/
â”‚           â””â”€â”€ edtech-specific.ts   # EdTech analytics queries
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ erd.md                 # âœ… Auto-generated
â”‚   â””â”€â”€ schema/                # Domain-specific ERDs
â”‚       â”œâ”€â”€ erd-learning.md
â”‚       â”œâ”€â”€ erd-gamification.md
â”‚       â””â”€â”€ erd-analytics.md
â””â”€â”€ scripts/
    â”œâ”€â”€ generate-erd.ts
    â””â”€â”€ check-db-tools.ts
```

---

## ğŸ”§ Phase 1: Foundation Setup

### 1.1 ERD Generator - Domain-Specific Views

Táº¡o ERD riÃªng cho tá»«ng domain Ä‘á»ƒ dá»… hiá»ƒu:

| Domain | Tables Included |
|--------|-----------------|
| **Learning** | Course, Lesson, UserProgress, User |
| **Gamification** | User, Achievement, UserAchievement, UserStreak, BuddyGroup |
| **Social** | User, SocialPost, BuddyGroup, UserRelationship |
| **Analytics** | BehaviorLog, User, UserProgress |
| **Simulation** | VirtualPortfolio, SimulationScenario, InvestmentProfile |

### 1.2 Snaplet - EdTech Data Factories

**Scenarios:**
- `dev`: 50 users, 10 courses, 7 days behavior logs
- `test`: 20 users, 5 courses, 3 days logs (CI/CD)
- `demo`: 200 users, 25 courses, 30 days logs (Sales demo)
- `benchmark`: 10,000 users, 100 courses, 90 days logs (Load testing)

### 1.3 NocoDB - Safe Configuration

**Access Levels:**
- **Development**: Full read/write access
- **Staging**: Read-only + content management tables only
- **Production**: Read-only with audit logging

---

## ğŸ—ï¸ Phase 2: Module Integration

### 2.1 Analytics Repository (Kysely)

**Key Queries for EdTech:**

| Query | Purpose | Complexity |
|-------|---------|------------|
| `getDailyActiveUsers()` | DAU tracking for investors | Medium |
| `getLearningFunnel()` | Signup â†’ Completion funnel | High |
| `getCohortRetention()` | Weekly retention by signup cohort | High |
| `getCourseCompletionByLevel()` | Difficulty analysis | Medium |
| `getStudentBehaviorPattern()` | AI personalization input | High |
| `getLeaderboard()` | Gamification ranking | Medium |

### 2.2 Gamification Module (Kysely)

**Batch Operations:**
- `processStreakUpdates()` - Daily cron job
- `awardBulkPoints()` - Efficient bulk point awards
- Complex leaderboard calculations

---

## ğŸ”„ Phase 3: CI/CD Integration

### GitHub Actions Workflow

```yaml
# Triggers on prisma/** changes
jobs:
  erd-generation:      # Generate + comment ERD on PR
  integration-tests:   # Seed test data + run e2e tests
  kysely-type-check:   # Verify types are in sync
  benchmark-seed:      # Performance test on main branch
```

### Pre-commit Hooks

```bash
# Auto-regenerate on schema.prisma changes
if schema changed:
  npx prisma generate
  git add docs/erd.md src/database/types.ts
```

---

## ğŸŒ Phase 4: Environment Matrix

| Tool | Development | Testing/CI | Staging | Production |
|------|-------------|------------|---------|------------|
| **ERD** | âœ… On-demand | âœ… CI artifact | âœ… Doc site | âŒ N/A |
| **Snaplet** | âœ… Full seed | âœ… Minimal seed | âœ… Demo seed | âŒ Never |
| **NocoDB** | âœ… Full access | âŒ N/A | âœ… Read-only | âš ï¸ Read-only + audit |
| **Kysely** | âœ… Debug logging | âœ… No logging | âœ… Metrics only | âœ… Metrics + slow query alerts |

---

## ğŸ“Š EdTech-Specific Use Cases

| Use Case | Primary Tool | Example |
|----------|--------------|---------|
| **Student Progress Dashboard** | Kysely | Complex aggregations across courses |
| **Course Content Management** | NocoDB | Instructors editing course metadata |
| **A/B Test Analytics** | Kysely | Cohort analysis, funnel metrics |
| **Development Debugging** | NocoDB | Quick data inspection |
| **Documentation** | ERD Generator | Onboarding new developers |
| **Load Testing Setup** | Snaplet | Generate 10k+ students |
| **Demo Environment** | Snaplet + NocoDB | Reproducible demo data for sales |

---

## ğŸ“œ Scripts to Add

```json
{
  "scripts": {
    "db:generate": "prisma generate",
    "db:erd": "prisma generate && echo 'ERD at docs/erd.md'",
    
    "db:seed": "ts-node prisma/seeds/index.ts",
    "db:seed:dev": "ts-node prisma/seeds/index.ts dev",
    "db:seed:test": "ts-node prisma/seeds/index.ts test",
    "db:seed:demo": "ts-node prisma/seeds/index.ts demo",
    "db:seed:benchmark": "ts-node prisma/seeds/index.ts benchmark",
    
    "db:nocodb:up": "docker-compose -f ../../docker-compose.nocodb.yml up -d",
    "db:nocodb:down": "docker-compose -f ../../docker-compose.nocodb.yml down"
  }
}
```

---

## âœ… Success Metrics

| Metric | Target |
|--------|--------|
| ERD generation time | < 10s |
| Seed time (dev) | < 30s |
| Seed time (benchmark 10k) | < 5min |
| Kysely type coverage | 100% |
| Complex query p95 | < 500ms |

---

## ğŸš€ Quick Start Commands

```bash
# 1. Generate ERD + Kysely types
cd apps/api && npx prisma generate

# 2. Start NocoDB
docker-compose -f docker-compose.nocodb.yml up -d
# Access: http://localhost:8080

# 3. Seed development data
cd apps/api && npx ts-node prisma/seeds/index.ts dev

# 4. Use Kysely in code
# Import KyselyModule into AppModule, inject KyselyService
```

---

## ğŸ“‹ Implementation Checklist

### Week 1: Foundation
- [ ] Create `prisma/seeds/` directory structure
- [ ] Implement user.factory.ts with Vietnamese names
- [ ] Implement course.factory.ts with financial education content
- [ ] Implement behavior.factory.ts for realistic time-series data
- [ ] Configure NocoDB read-only mode for production

### Week 2-3: Module Integration
- [ ] Create AnalyticsRepository with Kysely queries
- [ ] Integrate KyselyModule into AppModule
- [ ] Implement DAU/MAU tracking queries
- [ ] Implement cohort retention analysis
- [ ] Implement student risk detection query

### Week 4: CI/CD
- [ ] Create .github/workflows/database-tools.yml
- [ ] Add pre-commit hooks for schema changes
- [ ] Configure ERD artifact upload
- [ ] Add benchmark job for main branch

### Week 5: Polish
- [ ] Create environment-specific configurations
- [ ] Write team documentation
- [ ] Conduct training session
- [ ] Performance optimization

---

*Plan created: 2024-12-22*
*Target completion: 5 weeks*
