name: Deploy to Production (Kamal)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:buildcache,mode=max
      
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-web:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-web:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-web:buildcache,mode=max

  deploy:
    name: Deploy with Kamal
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install Kamal
        run: gem install kamal
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add servers to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.DATABASE_SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Create Kamal env file
        run: |
          mkdir -p .kamal
          cat > .kamal/.env << EOF
          KAMAL_REGISTRY_PASSWORD=${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          GOOGLE_AI_API_KEY=${{ secrets.GOOGLE_AI_API_KEY }}
          EOF
      
      - name: Deploy with Kamal
        run: |
          echo "ðŸš€ Starting production deployment..."
          kamal deploy
      
      - name: Run health checks
        run: |
          echo "ðŸ¥ Running production health checks..."
          
          MAX_RETRIES=15
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null https://api.v-edfinance.com/api/health; then
              echo "âœ… API is healthy!"
              
              if curl -f -s -o /dev/null https://v-edfinance.com; then
                echo "âœ… Frontend is healthy!"
                exit 0
              fi
            fi
            
            echo "â³ Waiting for services... ($(($RETRY_COUNT + 1))/$MAX_RETRIES)"
            sleep 15
            RETRY_COUNT=$(($RETRY_COUNT + 1))
          done
          
          echo "âŒ Health check failed"
          kamal app logs --follow
          exit 1
      
      - name: Notify on success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€ Production Deployment Successful\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Version\", \"value\": \"[\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\"},
                  {\"name\": \"Deployed by\", \"value\": \"${{ github.actor }}\"},
                  {\"name\": \"Environment\", \"value\": \"Production\"},
                  {\"name\": \"URL\", \"value\": \"https://v-edfinance.com\"}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK" || echo "Notification skipped"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Rolling back..."
          kamal rollback "${GITHUB_SHA:0:7}"
          
          # Notify Discord
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ Production Deployment Failed - Rolled Back\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Failed Version\", \"value\": \"[\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\"},
                  {\"name\": \"Action\", \"value\": \"Automatic rollback initiated\"}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" || echo "Notification skipped"
