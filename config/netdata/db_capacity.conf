# Database Capacity Alerts for Netdata
# Location: /etc/netdata/health.d/db_capacity.conf
# Documentation: DBRE Skill - Proactive capacity planning

# Alert: Database size exceeds 40GB (warning threshold)
 alarm: vedfinance_db_size_warn
    on: postgres.db_size
lookup: average -5m
 units: GB
 every: 1h
  warn: $this > 40
  info: V-EdFinance database size > 40GB - consider archiving old BehaviorLogs
    to: sysadmin

# Alert: Database size exceeds 60GB (critical threshold)
 alarm: vedfinance_db_size_critical
    on: postgres.db_size
lookup: average -5m
 units: GB
 every: 30m
  crit: $this > 60
  info: V-EdFinance database size > 60GB - URGENT: archive or scale storage
    to: sysadmin

# Alert: BehaviorLog table growing too fast
 alarm: behaviorlog_growth_rate
    on: postgres.table_size
lookup: sum -1h
 units: MB/h
 every: 1h
  warn: $this > 500
  crit: $this > 1000
  info: BehaviorLog table growing rapidly - check for logging loops
    to: sysadmin

# Alert: Connection pool exhaustion
 alarm: pg_connection_usage_high
    on: postgres.connections_utilization
lookup: average -5m
 units: %
 every: 5m
  warn: $this > 80
  crit: $this > 95
  info: PostgreSQL connection pool > 80% utilized - consider increasing max_connections
    to: sysadmin

# Alert: Slow query detected (avg exec time > 1s)
 alarm: pg_slow_queries
    on: postgres.query_time
lookup: average -10m
 units: ms
 every: 10m
  warn: $this > 1000
  crit: $this > 5000
  info: Average query execution time > 1s - check pg_stat_statements for slow queries
    to: sysadmin

# Alert: Cache hit ratio below 90% (needs tuning)
 alarm: pg_cache_hit_ratio_low
    on: postgres.cache_hit_ratio
lookup: average -10m
 units: %
 every: 10m
  warn: $this < 90
  crit: $this < 80
  info: PostgreSQL cache hit ratio < 90% - increase shared_buffers or investigate disk I/O
    to: sysadmin

# Alert: Disk space usage (VPS level)
 alarm: vps_disk_usage_warn
    on: disk.space
lookup: average -5m
 units: %
 every: 30m
  warn: $this > 70
  crit: $this > 85
  info: VPS disk usage > 70% - cleanup old backups or expand storage
    to: sysadmin
