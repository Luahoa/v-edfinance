import { expect, test } from '@playwright/test';
import AxeBuilder from '@axe-core/playwright';

test.describe('E020: Accessibility Compliance', () => {
  const criticalPages = [
    { path: '/vi', name: 'Home' },
    { path: '/vi/login', name: 'Login' },
    { path: '/vi/register', name: 'Register' },
    { path: '/vi/dashboard', name: 'Dashboard' },
    { path: '/vi/courses', name: 'Courses' },
    { path: '/vi/wallet', name: 'Wallet' },
  ];

  for (const pageInfo of criticalPages) {
    test(`WCAG 2.1 AA compliance for ${pageInfo.name}`, async ({ page }) => {
      await page.goto(pageInfo.path);
      await page.waitForLoadState('networkidle');

      const accessibilityScanResults = await new AxeBuilder({ page })
        .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
        .analyze();

      expect(accessibilityScanResults.violations).toEqual([]);

      if (accessibilityScanResults.violations.length > 0) {
        console.log(`Accessibility violations on ${pageInfo.name}:`);
        accessibilityScanResults.violations.forEach((violation) => {
          console.log(`  - ${violation.id}: ${violation.description}`);
          console.log(`    Impact: ${violation.impact}`);
          console.log(`    Elements: ${violation.nodes.length}`);
        });
      }
    });
  }

  test('Keyboard navigation throughout the app', async ({ page }) => {
    await page.goto('/vi');
    await page.waitForLoadState('networkidle');

    await page.keyboard.press('Tab');
    let focusedElement = await page.evaluate(() => document.activeElement?.tagName);
    expect(['A', 'BUTTON', 'INPUT']).toContain(focusedElement);

    for (let i = 0; i < 10; i++) {
      await page.keyboard.press('Tab');
      await page.waitForTimeout(100);
    }

    const currentFocus = await page.evaluate(() => {
      const el = document.activeElement;
      return {
        tag: el?.tagName,
        role: el?.getAttribute('role'),
        tabIndex: el?.getAttribute('tabindex'),
      };
    });

    expect(['A', 'BUTTON', 'INPUT', 'SELECT', 'TEXTAREA']).toContain(currentFocus.tag);

    const loginLink = page.locator('a[href*="login"]').first();
    if (await loginLink.isVisible()) {
      await loginLink.focus();
      await page.keyboard.press('Enter');
      await page.waitForTimeout(1000);
      await expect(page).toHaveURL(/login/);
    }
  });

  test('Screen reader support with ARIA labels', async ({ page }) => {
    await page.goto('/vi/dashboard');
    await page.waitForLoadState('networkidle');

    const ariaLabels = await page.evaluate(() => {
      const elements = document.querySelectorAll('[aria-label], [aria-labelledby], [aria-describedby]');
      return Array.from(elements).map((el) => ({
        tag: el.tagName,
        ariaLabel: el.getAttribute('aria-label'),
        ariaLabelledBy: el.getAttribute('aria-labelledby'),
        ariaDescribedBy: el.getAttribute('aria-describedby'),
        role: el.getAttribute('role'),
      }));
    });

    expect(ariaLabels.length).toBeGreaterThan(5);

    const buttons = page.locator('button');
    const buttonCount = await buttons.count();

    for (let i = 0; i < Math.min(buttonCount, 10); i++) {
      const button = buttons.nth(i);
      const hasAriaLabel = (await button.getAttribute('aria-label')) !== null;
      const hasTextContent = ((await button.textContent()) || '').trim().length > 0;
      const hasAriaLabelledBy = (await button.getAttribute('aria-labelledby')) !== null;

      expect(hasAriaLabel || hasTextContent || hasAriaLabelledBy).toBeTruthy();
    }
  });

  test('Color contrast meets WCAG AA standards', async ({ page }) => {
    await page.goto('/vi');
    await page.waitForLoadState('networkidle');

    const contrastResults = await new AxeBuilder({ page }).withTags(['wcag2aa']).options({ rules: { 'color-contrast': { enabled: true } } }).analyze();

    const contrastViolations = contrastResults.violations.filter((v) => v.id === 'color-contrast');

    expect(contrastViolations.length).toBe(0);

    if (contrastViolations.length > 0) {
      console.log('Color contrast violations:');
      contrastViolations.forEach((violation) => {
        violation.nodes.forEach((node) => {
          console.log(`  - ${node.html}`);
          console.log(`    Contrast: ${node.any[0]?.data?.contrastRatio || 'N/A'}`);
        });
      });
    }
  });

  test('Focus indicators are visible', async ({ page }) => {
    await page.goto('/vi/login');
    await page.waitForLoadState('networkidle');

    const emailInput = page.locator('input[name="email"], input[type="email"]').first();
    if (await emailInput.isVisible()) {
      await emailInput.focus();

      const focusStyle = await emailInput.evaluate((el) => {
        const styles = window.getComputedStyle(el);
        return {
          outline: styles.outline,
          outlineWidth: styles.outlineWidth,
          outlineColor: styles.outlineColor,
          boxShadow: styles.boxShadow,
        };
      });

      const hasFocusIndicator =
        focusStyle.outline !== 'none' ||
        focusStyle.outlineWidth !== '0px' ||
        focusStyle.boxShadow !== 'none';

      expect(hasFocusIndicator).toBeTruthy();
    }
  });

  test('Form validation errors are announced', async ({ page }) => {
    await page.goto('/vi/register');
    await page.waitForLoadState('networkidle');

    const submitButton = page.locator('button[type="submit"]').first();
    if (await submitButton.isVisible()) {
      await submitButton.click();
      await page.waitForTimeout(1000);

      const errorMessages = page.locator('[role="alert"], [aria-live="polite"], [aria-live="assertive"]');
      const errorCount = await errorMessages.count();

      if (errorCount > 0) {
        for (let i = 0; i < errorCount; i++) {
          const errorMsg = errorMessages.nth(i);
          const ariaLive = await errorMsg.getAttribute('aria-live');
          const role = await errorMsg.getAttribute('role');

          expect(ariaLive || role).toBeTruthy();
        }
      }

      const emailInput = page.locator('input[name="email"], input[type="email"]').first();
      if (await emailInput.isVisible()) {
        const ariaInvalid = await emailInput.getAttribute('aria-invalid');
        const ariaDescribedBy = await emailInput.getAttribute('aria-describedby');

        expect(ariaInvalid === 'true' || ariaDescribedBy !== null).toBeTruthy();
      }
    }
  });

  test('Alternative text for images', async ({ page }) => {
    await page.goto('/vi/courses');
    await page.waitForLoadState('networkidle');

    const images = page.locator('img');
    const imageCount = await images.count();

    let imagesWithAlt = 0;
    let decorativeImages = 0;

    for (let i = 0; i < imageCount; i++) {
      const img = images.nth(i);
      const alt = await img.getAttribute('alt');
      const role = await img.getAttribute('role');

      if (alt !== null) {
        if (alt.trim().length > 0) {
          imagesWithAlt++;
        } else if (role === 'presentation' || role === 'none') {
          decorativeImages++;
        }
      }
    }

    const totalProperlyLabeled = imagesWithAlt + decorativeImages;
    const coverage = imageCount > 0 ? (totalProperlyLabeled / imageCount) * 100 : 100;

    expect(coverage).toBeGreaterThanOrEqual(90);
  });
});
