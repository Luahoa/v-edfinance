version: "1.0"

# Dokploy Configuration for V-EdFinance
# Manages Development and Staging environments on single VPS

name: v-edfinance
domain: dokploy.v-edfinance.com

# PostgreSQL - Shared for dev/staging/production (with pgvector)
postgres:
  serviceName: postgres
  image: pgvector/pgvector:pg17  # Changed from postgres:17-alpine to include pgvector
  ports:
    - "5432:5432"
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql  # Auto-create databases
  environment:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    POSTGRES_DB: vedfinance
  resources:
    memory: 1024m  # Increased from 512m for production load
    cpus: 1.0      # Increased from 0.5
  healthCheck:
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    interval: 10s
    timeout: 5s
    retries: 5

# Redis - Shared cache
redis:
  serviceName: redis
  image: redis:7-alpine
  ports:
    - "6379:6379"
  resources:
    memory: 256m
    cpus: 0.25

# Development Environment
applications:
  - name: api-dev
    github:
      repository: luaho/v-edfinance
      branch: develop
      path: /
    buildType: dockerfile
    dockerfile: apps/api/Dockerfile
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/vedfinance_dev?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET_DEV}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
    port: 3000
    domain: api-dev.v-edfinance.com
    healthCheck:
      path: /api/health
      interval: 30
    resources:
      memory: 512m
      cpus: 0.5
    replicas: 1

  - name: web-dev
    github:
      repository: luaho/v-edfinance
      branch: develop
      path: /
    buildType: dockerfile
    dockerfile: apps/web/Dockerfile
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=https://api-dev.v-edfinance.com
    port: 3000
    domain: dev.v-edfinance.com
    healthCheck:
      path: /
      interval: 30
    resources:
      memory: 512m
      cpus: 0.5
    replicas: 1

  # Staging Environment
  - name: api-staging
    github:
      repository: luaho/v-edfinance
      branch: staging
      path: /
    buildType: dockerfile
    dockerfile: apps/api/Dockerfile
    environment:
      - NODE_ENV=staging
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/vedfinance_staging?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET_STAGING}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
    port: 3000
    domain: api-staging.v-edfinance.com
    healthCheck:
      path: /api/health
      interval: 30
    resources:
      memory: 768m
      cpus: 0.75
    replicas: 1

  - name: web-staging
    github:
      repository: luaho/v-edfinance
      branch: staging
      path: /
    buildType: dockerfile
    dockerfile: apps/web/Dockerfile
    environment:
      - NODE_ENV=staging
      - NEXT_PUBLIC_API_URL=https://api-staging.v-edfinance.com
    port: 3000
    domain: staging.v-edfinance.com
    healthCheck:
      path: /
      interval: 30
    resources:
      memory: 768m
      cpus: 0.75
    replicas: 1

  # Production Environment (Main Branch)
  - name: api-production
    github:
      repository: luaho/v-edfinance
      branch: main
      path: /
    buildType: dockerfile
    dockerfile: apps/api/Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/vedfinance_prod?schema=public
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET=${JWT_SECRET_PROD}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET_PROD}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY_PROD}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CORS_ORIGIN=https://v-edfinance.com,https://www.v-edfinance.com
    port: 3000
    domain: api.v-edfinance.com
    healthCheck:
      path: /api/health
      interval: 30
    resources:
      memory: 1536m  # Increased from 768m for production
      cpus: 1.5      # Increased from 0.75 for production
    replicas: 2      # High availability with 2 replicas
    restartPolicy: always
    deploymentStrategy:
      type: rolling
      maxSurge: 1
      maxUnavailable: 0  # Zero-downtime deployment

  - name: web-production
    github:
      repository: luaho/v-edfinance
      branch: main
      path: /
    buildType: dockerfile
    dockerfile: apps/web/Dockerfile
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://api.v-edfinance.com
      - NEXT_TELEMETRY_DISABLED=1
    port: 3000
    domain: v-edfinance.com
    additionalDomains:
      - www.v-edfinance.com
    healthCheck:
      path: /
      interval: 30
    resources:
      memory: 1024m  # Increased from 768m
      cpus: 1.0      # Increased from 0.75
    replicas: 2      # High availability
    restartPolicy: always
    deploymentStrategy:
      type: rolling
      maxSurge: 1
      maxUnavailable: 0

# Monitoring
monitoring:
  - name: uptime-kuma
    image: louislam/uptime-kuma:1
    port: 3001
    domain: monitoring.v-edfinance.com
    volumes:
      - uptime_data:/app/data
    resources:
      memory: 256m
      cpus: 0.25

volumes:
  postgres_data:
  uptime_data:

# Auto-deploy on push
autoDeployment:
  enabled: true
  branches:
    - develop  # Auto-deploy dev
    - staging  # Auto-deploy staging
    - main     # Auto-deploy production (requires approval)

# SSL Configuration
ssl:
  enabled: true
  provider: letsencrypt
  email: admin@v-edfinance.com

# Backups
backups:
  enabled: true
  schedule: "0 3 * * *"  # Daily at 3 AM
  retention: 7  # Keep 7 days
  databases:
    - postgres
