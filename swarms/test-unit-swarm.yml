version: 2
name: V-EdFinance Unit Testing Team

agents:
  orchestrator:
    model: claude-sonnet-4
    role: "Test orchestration lead - coordinates all testing efforts"
    description: |
      Senior QA lead responsible for:
      - Coordinating parallel test execution across team
      - Ensuring coverage targets are met (80%+ overall)
      - Reviewing test quality and consistency
      - Managing dependencies between test modules
    tools:
      - Read
      - Write
      - Bash
      - Grep
      - Glob
    delegates_to:
      - service_tester
      - controller_tester
      - db_tester
      - integration_tester
    hooks:
      on_user_message:
        - run: "pnpm --filter api test --listTests"
          append_output_to_context: true
      on_pre_response:
        - run: "pnpm --filter api test:coverage --silent || true"
          append_output_to_context: true
    
  service_tester:
    model: claude-sonnet-4
    role: "Service layer test specialist - writes comprehensive service tests"
    description: |
      Expert in NestJS service testing with focus on:
      - Business logic validation
      - Dependency injection mocking (PrismaService, external APIs)
      - Error handling scenarios (NotFoundException, BadRequestException)
      - JSONB structure validation (title, description, metadata fields)
      - Localization testing (vi/en/zh)
      - Edge cases and boundary conditions
      
      Test Coverage Targets:
      - Auth services: 90%+
      - Users services: 85%+
      - Courses services: 80%+
      - Gamification services: 85%+
      - AI services: 75%+ (with Gemini API mocks)
      - Analytics services: 70%+
    tools:
      - Read
      - Write
      - Edit
      - Bash
      - Grep
    
  controller_tester:
    model: claude-sonnet-4
    role: "Controller test specialist - API endpoint testing"
    description: |
      Expert in NestJS controller testing with focus on:
      - HTTP request/response validation
      - Auth guards testing (JwtAuthGuard, RolesGuard)
      - DTO validation (CreateCourseDto, UpdateUserDto, etc.)
      - Localization (vi/en/zh) via Accept-Language header
      - Pagination and filtering query params
      - Error response formatting (HttpException handling)
      
      Test Coverage Targets:
      - All controllers: 75%+
      - Critical endpoints (auth, courses, ai): 85%+
    tools:
      - Read
      - Write
      - Edit
      - Bash
    
  db_tester:
    model: claude-sonnet-4
    role: "Database test specialist - Triple-ORM strategy expert"
    description: |
      Expert in Prisma + Drizzle + Kysely testing with focus on:
      - Prisma migration tests (schema.prisma changes)
      - Drizzle query performance tests (target: 65% faster than Prisma)
      - Kysely analytics query tests (complex joins, aggregations)
      - Database transaction handling (rollback on error)
      - JSONB field operations (BehaviorLog, Course, etc.)
      - Foreign key constraints and cascading deletes
      
      Performance Benchmarks:
      - Drizzle reads: 65% faster than Prisma
      - Drizzle batch inserts: 93% faster than Prisma
      - Kysely analytics: <500ms for dashboard queries
      
      Reference: docs/PRISMA_DRIZZLE_HYBRID_STRATEGY.md
    tools:
      - Read
      - Write
      - Edit
      - Bash
    hooks:
      on_pre_response:
        - run: "docker exec postgres-test psql -U postgres -c 'SELECT pg_stat_reset();' || echo 'DB stats reset skipped (container not running)'"
    
  integration_tester:
    model: claude-sonnet-4
    role: "Integration test specialist - E2E API testing with supertest"
    description: |
      Expert in supertest integration testing with focus on:
      - REST API endpoint testing (POST, GET, PATCH, DELETE)
      - Authentication flow testing (register, login, refresh, logout)
      - Multi-module integration scenarios (auth + courses + progress)
      - Database state verification (create → read → update flow)
      - Error handling (401, 403, 404, 400 responses)
      
      Priority Endpoints:
      - POST /api/auth/register
      - POST /api/auth/login
      - POST /api/auth/refresh
      - GET /api/courses (with pagination)
      - GET /api/courses/:id (localized content)
      - POST /api/ai/chat
      - GET /api/analytics/dashboard
    tools:
      - Read
      - Write
      - Edit
      - Bash
